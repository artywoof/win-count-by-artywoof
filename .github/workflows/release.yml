name: ğŸš€ Auto Release - Win Count by ArtYWoof

on:
  push:
    tags:
      - 'v1.0.0'  # à¹€à¸Šà¹ˆà¸™ v1.0.0, v1.0.1, v2.0.0

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.result }}
      release_upload_url: ${{ steps.create-release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ·ï¸ Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
      - name: ğŸ“ Create Release
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: '${{ steps.get_version.outputs.VERSION }}',
              name: 'Win Count ${{ steps.get_version.outputs.VERSION }}',
              body: `## ğŸ‰ Win Count by ArtYWoof ${{ steps.get_version.outputs.VERSION }}
              
              ### âœ¨ What's New:
              - Performance improvements
              - Bug fixes and stability updates
              - Enhanced user experience
              
              ### ğŸ“¥ Installation:
              Download the \`.msi\` file below and run it to install or update Win Count.
              
              ### ğŸ”„ Auto-Update:
              If you have an older version installed, the app will automatically notify you about this update.
              
              ---
              
              **Full Changelog**: https://github.com/${{ github.repository }}/compare/v1.0.0...${{ steps.get_version.outputs.VERSION }}`,
              draft: false,
              prerelease: false
            });
            return data.id;

  build-windows:
    needs: create-release
    runs-on: windows-latest
    
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ¦€ Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: ğŸ“¦ Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: ğŸ“¦ Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: ğŸ”§ Install dependencies
        run: bun install

      - name: ğŸ—ï¸ Build frontend
        run: bun run build:frontend

      - name: ğŸ·ï¸ Get version
        id: get_version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: ğŸ“± Build Tauri app with updater
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ""  # à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ password à¹ƒà¸™ key
        with:
          tagName: ${{ steps.get_version.outputs.VERSION }}
          releaseName: 'Win Count ${{ steps.get_version.outputs.VERSION }}'
          releaseBody: |
            ğŸ‰ Win Count by ArtYWoof ${{ steps.get_version.outputs.VERSION }}
            
            âœ¨ **New in this version:**
            - Enhanced performance and stability
            - Bug fixes and improvements
            - Better user experience
            
            ğŸ“¥ **How to install:**
            1. Download the `.msi` file below
            2. Run it as Administrator
            3. Follow the installation wizard
            
            ğŸ”„ **Auto-update available:**
            The app will automatically check for updates and notify you when new versions are available.
          releaseDraft: false
          prerelease: false
          includeUpdaterJson: true
          updaterJsonPreferNsis: false
          updaterJsonKeepUniversal: false

  # Job à¸ªà¸³à¸«à¸£à¸±à¸šà¸—à¸”à¸ªà¸­à¸š auto-update à¸«à¸¥à¸±à¸‡ release
  test-release:
    needs: [create-release, build-windows]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: âœ… Verify release files
        uses: actions/github-script@v7
        with:
          script: |
            const { data: release } = await github.rest.repos.getRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ needs.create-release.outputs.release_id }}
            });
            
            console.log('ğŸ“‹ Release created:', release.name);
            console.log('ğŸ”— Release URL:', release.html_url);
            console.log('ğŸ“¦ Assets count:', release.assets.length);
            
            // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µà¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™
            const requiredFiles = ['.msi', '.msi.sig', 'latest.json'];
            const assetNames = release.assets.map(asset => asset.name);
            
            for (const fileType of requiredFiles) {
              const found = assetNames.some(name => name.includes(fileType));
              if (found) {
                console.log('âœ… Found', fileType, 'file');
              } else {
                console.log('âŒ Missing', fileType, 'file');
                throw new Error(`Missing required file: ${fileType}`);
              }
            }
            
            console.log('ğŸ‰ All required files are present!');

      - name: ğŸ” Check updater JSON
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const https = require('https');
            
            const downloadUrl = `https://github.com/${{ github.repository }}/releases/latest/download/latest.json`;
            
            // à¸£à¸­à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆà¹ƒà¸«à¹‰ GitHub CDN à¸­à¸±à¸›à¹€à¸”à¸•
            await new Promise(resolve => setTimeout(resolve, 30000));
            
            try {
              const response = await fetch(downloadUrl);
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              
              const latestJson = await response.json();
              console.log('ğŸ“„ latest.json content:', JSON.stringify(latestJson, null, 2));
              
              // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š structure
              if (!latestJson.version) throw new Error('Missing version in latest.json');
              if (!latestJson.platforms) throw new Error('Missing platforms in latest.json');
              if (!latestJson.platforms['windows-x86_64']) throw new Error('Missing windows-x86_64 platform');
              
              console.log('âœ… latest.json is valid!');
              console.log('ğŸ·ï¸ Version:', latestJson.version);
              console.log('ğŸ“… Published:', latestJson.pub_date);
              
            } catch (error) {
              console.error('âŒ Failed to verify latest.json:', error.message);
              // à¹„à¸¡à¹ˆ fail job à¹€à¸à¸£à¸²à¸°à¸­à¸²à¸ˆà¸ˆà¸°à¸¢à¸±à¸‡ propagate à¹„à¸¡à¹ˆà¸—à¸±à¸™
              console.log('âš ï¸ This might be temporary - CDN propagation delay');
            }

  # Notification job
  notify-completion:
    needs: [create-release, build-windows, test-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ‰ Release Summary
        uses: actions/github-script@v7
        with:
          script: |
            const { data: release } = await github.rest.repos.getRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ needs.create-release.outputs.release_id }}
            });
            
            const status = '${{ needs.build-windows.result }}' === 'success' ? 'âœ… SUCCESS' : 'âŒ FAILED';
            const emoji = '${{ needs.build-windows.result }}' === 'success' ? 'ğŸ‰' : 'ğŸ’¥';
            
            console.log(`${emoji} Release Status: ${status}`);
            console.log(`ğŸ·ï¸ Version: ${release.tag_name}`);
            console.log(`ğŸ”— Release URL: ${release.html_url}`);
            console.log(`ğŸ“¦ Assets: ${release.assets.length} files`);
            
            if ('${{ needs.build-windows.result }}' === 'success') {
              console.log('');
              console.log('ğŸ¯ Next Steps:');
              console.log('1. Test the auto-update functionality');
              console.log('2. Verify the MSI installer works correctly');
              console.log('3. Check that latest.json is accessible');
              console.log('');
              console.log('ğŸ”„ Auto-update endpoint:');
              console.log(`https://github.com/${{ github.repository }}/releases/latest/download/latest.json`);
            } 